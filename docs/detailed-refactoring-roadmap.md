This document outlines a detailed roadmap for refactoring and enhancing code quality across the Project Wiz codebase, based on the principles and observations in the "Code Quality and Refactoring Guide".

| ID      | Target Component(s)                             | Issue/Goal                                                                 | Relevant Standard(s)                     | Proposed Action(s)                                                                                                                                                            | Dependencies | Complexity | Priority | Status      | Notes                                                                                                                                |
|---------|-------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------|------------|----------|-------------|--------------------------------------------------------------------------------------------------------------------------------------|
| RT001.1 | `GenericAgentExecutor.processJob`               | Method too long, multiple responsibilities (init, planning, exec, error) | OC Rule 1 (Indent), OC Rule 7 (Small)    | Extract initial prompt construction logic into a new private method `_initializeConversationHistory(job, agentState, jobGoal)`.                                                               |              | M          | High     | Done        | Initial prompt construction logic (incl. `lastFailureSummary` handling) moved from `processJob` to private method `_initializeConversationHistory`. |
| RT001.2 | `GenericAgentExecutor.processJob`               | Method too long, LLM call and response parsing                             | OC Rule 1, OC Rule 7                     | Extract main `generateObject` call and its immediate response parsing to `_getNextLLMDecision(conversationHistory): Promise<{...}>`.                                                               |              | M          | High     | Done        | Method `_fetchNextLLMDecision` created, containing the `generateObject` call and its Zod schema. `processJob` now calls this method and uses its results. Isolates LLM interaction logic. |
| RT001.3 | `GenericAgentExecutor.processJob`               | Large conditional block for LLM response handling                          | OC Rule 1, OC Rule 7, SRP                | Break down `if/else if` for `clarifyingQuestions`, `requestReplan`, `toolCalls`, `stop`: <br> - `toolCalls` part extracted to `_executeToolsAndHandleResults`. (Done) <br> - Other conditions (`clarifyingQuestions`, `requestReplan`, `stop`) remain inline in `processJob` as distinct conditional blocks, further extraction deferred as current inline handling is manageable. | RT001.2      | L          | High     | Done        | The `toolCalls` branch of the conditional logic within `processJob` is now handled by the `_executeToolsAndHandleResults` method. This method manages tool iteration, execution, error handling for individual tools, and updates conversation history. `processJob` integrates these results. Other LLM response types (`clarifyingQuestions`, `requestReplan`, `stop`) are handled by their own conditional blocks directly in `processJob` and are deemed manageable without further extraction for now. |
| RT002.1 | `WorkerService.processJob`                      | Job status update logic (switch statement) adds to method length           | OC Rule 1, OC Rule 7, SRP                | Extract job status update logic (switch on `executorResult.status`) into a private method `_finalizeJobState(job, executorResult)`.                                                              |              | S          | Medium   | Done        | Extracted job status update logic (switch on `executorResult.status`) from `WorkerService.processJob` into a new private method `_finalizeJobState(job, executorResult)`. `processJob` now calls this method and then saves the returned (modified) job. |
| RT002.2 | `WorkerService.processJob`                      | Main error handling `catch` block could be complex                         | OC Rule 1, OC Rule 7                     | Extract main error handling `catch` block logic (retry vs. fail) into `_handleJobProcessingError(job, error)` if it grows. (Monitor for now)                                                   |              | S          | Low      | Not Started |                                                                                                                                      |
| RT003.1 | `SaveMemoryItemUseCase`, `SearchSimilarMemoryItemsUseCase` | Direct dependency on `EmbeddingService` (infra)                          | Clean Arch: DIP, SOLID                   | Define `IEmbeddingService` port in `src/core/ports/services/embedding.interface.ts` with `generateEmbedding(text: string): Promise<number[]>` (or `EmbeddingResult`).                               |              | S          | High     | Done        | Interface `IEmbeddingService` defined in `src/core/ports/services/embedding.interface.ts` with `generateEmbedding(text: string): Promise<number[]>` and `readonly dimensions: number;`. |
| RT003.2 | `EmbeddingService`                              | Concrete class in infra                                                    | Clean Arch: DIP                          | Modify `EmbeddingService` (`src/infrastructure/services/ai/embedding.service.ts`) to implement `IEmbeddingService`.                                                                           | RT003.1      | S          | High     | Done        | `EmbeddingService` at `src/infrastructure/services/ai/embedding.service.ts` now implements `IEmbeddingService`. The `generateEmbedding` method was updated to return `Promise<number[]>` directly (stripping `usage` from `ai-sdk` result) and `dimensions` property was confirmed. |
| RT003.3 | `SaveMemoryItemUseCase`                         | Depends on concrete `EmbeddingService`                                     | Clean Arch: DIP                          | Modify `SaveMemoryItemUseCase` to depend on `IEmbeddingService` (injected via constructor).                                                                                                   | RT003.1      | S          | High     | Done        | `SaveMemoryItemUseCase` constructor now correctly typed with `IEmbeddingService`. Internal call to `generateEmbedding` updated to expect `Promise<number[]>` directly, aligning with interface changes. Path to use case is `src/core/application/use-cases/memory/save-memory-item.usecase.ts`. |
| RT003.4 | `SearchSimilarMemoryItemsUseCase`               | Depends on concrete `EmbeddingService`                                     | Clean Arch: DIP                          | Modify `SearchSimilarMemoryItemsUseCase` to depend on `IEmbeddingService` (injected via constructor).                                                                                         | RT003.1      | S          | High     | Done        | `SearchSimilarMemoryItemsUseCase` constructor now correctly typed with `IEmbeddingService`. Internal call to `generateEmbedding` updated to expect `Promise<number[]>` directly. Path to use case is `src/core/application/use-cases/memory/search-similar-memory-items.usecase.ts`. |
| RT003.5 | `main.ts`                                       | DI setup for UseCases                                                      | Clean Arch: DIP                          | Update `main.ts` to inject the `EmbeddingService` instance where `IEmbeddingService` is required for memory UseCases.                                                                             | RT003.2, RT003.3, RT003.4 | S          | High     | Done        | Verified `main.ts`. The `EmbeddingService` instance is already correctly instantiated and injected into `SaveMemoryItemUseCase` and `SearchSimilarMemoryItemsUseCase`. No code changes were required for this step as it appears to have been addressed previously. Other relevant files like `fullstack-agent-demo.ts` and `memory.tool.ts` either don't instantiate these use cases or receive them correctly. |
| RT004.1 | Error Handling (Project-wide)                   | Use of generic `Error`, inconsistent error messages                      | DX, Maintainability                      | Define custom error classes in `src/core/common/errors.ts` or `src/core/domain/errors/` (e.g., `ToolExecutionError`, `LLMError`, `ConfigurationError`, `JobProcessingError`).                 |              | M          | Medium   | Done        | Created `src/core/common/errors.ts` with a base `CoreError` and specific error classes: `ToolExecutionError`, `LLMError`, `ConfigurationError`, `JobProcessingError`, `NotFoundError`, `ValidationError`. Each extends `CoreError` and includes relevant contextual properties. |
| RT004.2 | Various components                              | Throwing/catching generic `Error`s                                         | DX, Maintainability                      | Refactor `GenericAgentExecutor`, tools, services to throw and catch these more specific error types where appropriate.                                                                            | RT004.1      | L          | Medium   | Done        | Refactored `GenericAgentExecutor` to throw and handle custom errors (e.g., `ConfigurationError` for API keys, `LLMError` for LLM calls, wraps tool errors). Refactored `FileSystemTool` to throw `ToolExecutionError` for fs operations and path issues. Refactored `WorkerService` to throw `NotFoundError` in `start()` and to catch specific custom errors in `processJob`, logging richer details and storing structured error info in `job.data.error` and `job.data.lastFailureSummary`. |
| RT004.3 | Logging (Project-wide)                          | Use of `console.log` directly                                              | DX, Maintainability                      | Introduce a simple structured logging utility/service (e.g., wrapping `console` or a lightweight library) and use it consistently. (Consider `createModuleLogger` pattern from user example). |              | M          | Medium   | Done        | Defined `ILogger` interface and `LogContext` type. Created `ConsoleLogger` implementation for structured JSON logging to the console (includes timestamp, level, message, context, error details). Exported a global `logger` instance. Refactored `GenericAgentExecutor` and `WorkerService` to use this logger, replacing `console.*` calls and adding structured context to log messages. |
| RT005.1 | `GenericAgentExecutor`                          | Hardcoded config (summarization thresholds, LLM models for internal tasks) | Configurability, Maintainability         | Define a structure/interface for `AgentExecutorConfig` (e.g., summarization params, internal LLM model names).                                                                                |              | S          | Medium   | Not Started |                                                                                                                                      |
| RT005.2 | Config Loading                                  | No central config loading for agent executor specifics                     | Configurability                          | Create/use a service to load this config (e.g., from a JSON file in `config/` or from main app config).                                                                                       | RT005.1      | M          | Medium   | Not Started |                                                                                                                                      |
| RT005.3 | `GenericAgentExecutor`                          | Uses hardcoded constants for config                                        | Configurability                          | Inject `AgentExecutorConfig` values into `GenericAgentExecutor` constructor or relevant methods.                                                                                              | RT005.2      | S          | Medium   | Not Started |                                                                                                                                      |
| RT006.1 | `Job.payload`                                   | Typed as `any`                                                             | Type Safety, DX                          | Define specific DTO interfaces for `job.payload` based on `job.name` or `targetAgentRole` where common patterns emerge (e.g., `{ goal: string; initialContext?: any; }` is a good start). `GenericAgentExecutor` to expect this. |              | M          | Medium   | Not Started | Can be iterative.                                                                                                                    |
| RT006.2 | `Job.data`                                      | Typed as `any`                                                             | Type Safety, DX                          | In `JobProps` (`job.entity.ts`), change `data?: any;` to `data?: JobRuntimeData;` where `JobRuntimeData { agentState?: AgentJobState; lastFailureSummary?: string; [key: string]: any; }`. Update users of `job.data`. |              | S          | High     | Done        | Defined `JobRuntimeData` interface in its own file. Updated `Job` entity (`JobProps`, `Job` class `data` property, `setData`, `moveToFailed`) to use `JobRuntimeData`. Verified and updated `WorkerService` and `GenericAgentExecutor` to ensure type-safe access and modification of `job.data` using the new type, including correction of import paths and ensuring preservation of existing data fields during updates. Removed duplicate `JobRuntimeData` from `job-processing.types.ts`. |
